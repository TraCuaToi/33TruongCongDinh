function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Orders");
  if (!sheet) {
    sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet("Orders");
    sheet.appendRow([
      "SĐT","Tên món","Size","SL","Topping",
      "Ghi chú","Tổng tiền","Thời gian","Trạng thái"
    ]);
  }

  var order = JSON.parse(e.parameter.order);

  var status = order.huyDon ? "Hủy đơn" : "Đơn mới";

  order.items.forEach(item => {
    var quantity = item.quantity;
    var totalPrice = item.price * item.quantity;

    if (status === "Hủy đơn") {
      quantity = quantity * -1;     // SL âm
      totalPrice = totalPrice * -1; // Tiền âm
    }

    sheet.appendRow([
      order.phoneNumber,
      item.name,
      item.size || "",
      String(quantity), // 👈 ghi số lượng (âm nếu hủy)
      (item.toppings || []).map(t => t.name).join(", "),
      order.notes || "",
      totalPrice,       // 👈 tiền âm nếu hủy
      new Date(),
      status
    ]);
  });
 
  return ContentService.createTextOutput("success");
   
}




function deleteVisibleRowsFrom17() {
  var adminEmail = "nguyenminh.code.edu@gmail.com"; // đổi thành email admin thật
  var userEmail = Session.getActiveUser().getEmail();

  if (userEmail !== adminEmail) {
    SpreadsheetApp.getUi().alert("❌ Bạn không có quyền xóa dòng. Chỉ admin được phép.");
    return;
  }

  var sheet = SpreadsheetApp.getActiveSheet();
  var lastRow = sheet.getLastRow();

  // Nếu dòng 17 hiển thị thì xóa từ 17 -> hết
  if (!sheet.isRowHiddenByFilter(17) && !sheet.isRowHiddenByUser(17)) {
    var count = lastRow - 16;
    if (count > 0) {
      sheet.deleteRows(17, count);
    }
  }
}

// Menu khi mở sheet
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu("🗑 Xóa dòng (Admin)")
    .addItem("Xóa từ dòng 17 trở đi(Chỉ xóa dòng đang hiện-Nhớ lọc những dòng cần xóa)", "deleteVisibleRowsFrom17")
    .addToUi();
}



